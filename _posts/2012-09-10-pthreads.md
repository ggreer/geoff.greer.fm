---
date: '2012-09-10 18:18:50'
layout: post
title: 'pthreads'
published: true
categories:
- Computers
- the_silver_searcher
---

For each file, create a new thread and search in that

{% highlight text %}
% time ./ag blahblahblah ..
...
./ag blahblahblah ..  2.18s user 20.91s system 152% cpu 15.134 total
%
{% endhighlight %}

Why is this 5x slower? Let's profile.

[![](/images/ag_profile_thread_per_file.png)](/images/ag_profile_thread_per_file.png)

Creating a new thread isn't free. There's overhead.

Next I tried a different model: Worker threads

{% highlight text %}
% time ./ag blahblahblah ..
...
./ag blahblahblah ..  1.47s user 2.54s system 231% cpu 1.731 total
%
{% endhighlight %}

Ah, that's better.


Tweaking the number of worker threads significantly affected performance. I assumed 3-4 workers would be ideal, but I wanted to make sure I was getting the best performance.

<div id="chart_div" style="width: 100%; height: 500px;"> </div>

These tests were done on a Core i7 3667U, a dual-core CPU with hyper-threading. For comparison: non-threaded Ag takes 2.0 seconds.

I think I'm getting pretty close to the maximum possible searching speed. Take a look at the profiling info now:

[![](/images/ag_profile_thread_workers.png)](/images/ag_profile_thread_workers.png)

There's no single bottleneck. All the time is spent doing things that simply have to be done.

<script type="text/javascript" src="https://www.google.com/jsapi"> </script>
<script type="text/javascript">
  // Load the Visualization API and the piechart package.
  google.load('visualization', '1.0', {'packages':['corechart']});

  // Set a callback to run when the Google Visualization API is loaded.
  google.setOnLoadCallback(drawChart);

  // Callback that creates and populates a data table,
  // instantiates the pie chart, passes in the data and
  // draws it.
  function drawChart() {
    // Create the data table.
    var data = new google.visualization.DataTable();
    data.addColumn("string", "Worker threads");
    data.addColumn("number", "Seconds");
    data.addRows([
      ["1", 1.536],
      ["2", 1.392],
      ["3", 1.471],
      ["4", 1.767],
      ["8", 2.677],
      ["16", 4.713]
    ]);
    // Set chart options
    var options = {
                    'title':'Ag worker thread benchmark',
                    'fontSize': 20,
                    'backgroundColor': {
                      'fill': '#eef'
                    },
                    'chartArea': {
                      'left': '10%',
                      'width': '85%'
                    },
                    'legend': {
                      'position': 'none'
                    },
                    'hAxis': {
                      'title': 'Worker threads'
                    },
                    'vAxis': {
                      'gridlines': {
                        'count': 6
                      },
                      'minValue': 0,
                      'title': 'Seconds'
                    },
                    'width': "100%",
                    'height': 500
                  };

    // Instantiate and draw our chart, passing in some options.
    var chart = new google.visualization.ChartWrapper({
      'chartType': 'ColumnChart',
      'containerId': 'chart_div',
      'options': options,
      'dataTable': data
    });
    chart.draw();
  }</script>
