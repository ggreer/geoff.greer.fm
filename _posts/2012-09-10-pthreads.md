---
date: '2012-09-10 18:18:50'
layout: post
title: 'Pthreads: The "P" Stands for Performance'
published: true
categories:
- Computers
- the_silver_searcher
---

(Not really. The P is for [POSIX](http://en.wikipedia.org/wiki/POSIX).)

In my quest to make Ag as fast as possible, I spent some time making it multi-threaded. This meant learning [Pthreads](http://en.wikipedia.org/wiki/POSIX_Threads), which was easier than I expected.

Although the Pthreads API isn't too hard to pick up, other architectural decisions took more effort to get right. My first attempt at multithreaded search was rather na√Øve. The plan was simple: For each file, create a new thread, search the file, then exit the thread.

A few hours later...

{% highlight text %}
% time ./ag blahblahblah ..
...
./ag blahblahblah ..  2.18s user 20.91s system 152% cpu 15.134 total
%
{% endhighlight %}

15 seconds? That's 7x slower than non-threaded Ag! Not knowing what is going on in the internals of my laptop, I break out the profiler.

[![](/images/ag_profile_thread_per_file.png)](/images/ag_profile_thread_per_file.png)

Creating a new thread isn't free. There's overhead.

Next I tried a different model: Worker threads

{% highlight text %}
% time ./ag blahblahblah ..
...
./ag blahblahblah ..  1.47s user 2.54s system 231% cpu 1.731 total
%
{% endhighlight %}

Ah, that's better. Still, it's only 0.3 seconds faster than non-threaded Ag.


Tweaking the number of worker threads significantly affected performance. I assumed 3-4 workers would be ideal, but I wanted to make sure I was getting the best performance.

<div id="chart_div" style="width: 100%; height: 500px;"> </div>

For comparison: non-threaded Ag takes 2.0 seconds.

There are some quick takeaways from this graph. First, OS X *sucks* at multi-threading. With 16 workers, the performance is pitiful. A modern Linux kernel seems to get things right. Second, 

I think I'm getting pretty close to the maximum possible searching speed. Take a look at the profiling info now:

[![](/images/ag_profile_thread_workers.png)](/images/ag_profile_thread_workers.png)

There's no bottleneck. All the time is spent doing things that simply have to be done.

<script type="text/javascript" src="https://www.google.com/jsapi"> </script>
<script type="text/javascript">
// Load the Visualization API and the piechart package.
google.load('visualization', '1.0', {'packages':['corechart']});

// Set a callback to run when the Google Visualization API is loaded.
google.setOnLoadCallback(drawChart);

// Callback that creates and populates a data table,
// instantiates the pie chart, passes in the data and
// draws it.
function drawChart() {
  // Create the data table.
  var data = new google.visualization.DataTable();
  data.addColumn("string", "Worker threads");
  data.addColumn("number", "OS X 10.8, Core i7 3667U@2.0Ghz");
  data.addColumn("number", "Ubuntu 12.04, Core 2 Duo E3200@3.2Ghz");
  data.addRows([
    ["1",  1.536, 1.419],
    ["2",  1.392, 1.358],
    ["3",  1.471, 1.848],
    ["4",  1.767, 1.894],
    ["8",  2.677, 2.025],
    ["16", 4.713, 2.066]
  ]);
  // Set chart options
  var options = {
                  'title':'Ag worker thread benchmark',
                  'fontSize': 20,
                  'backgroundColor': {
                    'fill': '#eef'
                  },
                  'chartArea': {
                    'left': '10%',
                    'width': '85%'
                  },
                  'legend': {
                    'position': 'top'
                  },
                  'hAxis': {
                    'title': 'Worker threads'
                  },
                  'vAxis': {
                    'gridlines': {
                      'count': 6
                    },
                    'minValue': 0,
                    'title': 'Seconds'
                  },
                  'width': "100%",
                  'height': 500
                };

  // Instantiate and draw our chart, passing in some options.
  var chart = new google.visualization.ChartWrapper({
    'chartType': 'ColumnChart',
    'containerId': 'chart_div',
    'options': options,
    'dataTable': data
  });
  chart.draw();
}
</script>
